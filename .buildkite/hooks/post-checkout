#!/bin/bash
set -euo pipefail

echo "--- :gear: Installing mise"
curl -sSf https://mise.run | sh
export PATH="$HOME/.local/bin:$PATH"

export MISE_DATA_DIR="${MISE_DATA_DIR:-.buildkite-cache/mise/data}"
export MISE_CACHE_DIR="${MISE_CACHE_DIR:-.buildkite-cache/mise/cache}"
export MISE_STATE_DIR="${MISE_STATE_DIR:-.buildkite-cache/mise/state}"

mkdir -p "$MISE_DATA_DIR" "$MISE_CACHE_DIR" "$MISE_STATE_DIR"

if command -v gh >/dev/null 2>&1; then
  if token="$(gh auth token 2>/dev/null)"; then
    export MISE_GITHUB_TOKEN="$token"
    if [[ -n "${BUILDKITE_ENV_FILE:-}" ]]; then
      printf 'export MISE_GITHUB_TOKEN=%q\n' "$token" >> "$BUILDKITE_ENV_FILE"
    fi
  fi
fi
