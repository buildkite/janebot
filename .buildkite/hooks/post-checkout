#!/bin/bash
set -euo pipefail

echo "--- :gear: Installing mise"
curl -sSf https://mise.run | sh
export PATH="$HOME/.local/bin:$PATH"

REPO_ROOT="$(git rev-parse --show-toplevel)"
to_absolute() {
  local path="$1"
  if [[ "$path" = /* ]]; then
    printf '%s\n' "$path"
  else
    printf '%s/%s\n' "$REPO_ROOT" "$path"
  fi
}

MISE_DATA_DIR="$(to_absolute "${MISE_DATA_DIR:-.buildkite-cache/mise/data}")"
MISE_CACHE_DIR="$(to_absolute "${MISE_CACHE_DIR:-.buildkite-cache/mise/cache}")"
MISE_STATE_DIR="$(to_absolute "${MISE_STATE_DIR:-.buildkite-cache/mise/state}")"

export MISE_DATA_DIR MISE_CACHE_DIR MISE_STATE_DIR

mkdir -p "$MISE_DATA_DIR" "$MISE_CACHE_DIR" "$MISE_STATE_DIR"

if command -v gh >/dev/null 2>&1; then
  if token="$(gh auth token 2>/dev/null)"; then
    export MISE_GITHUB_TOKEN="$token"
    if [[ -n "${BUILDKITE_ENV_FILE:-}" ]]; then
      printf 'export MISE_GITHUB_TOKEN=%q\n' "$token" >> "$BUILDKITE_ENV_FILE"
    fi
  fi
fi
